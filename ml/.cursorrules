# Reglas para Cursor AI - Sistema ML Agua Tres Torres

## ðŸŽ¯ Contexto del Proyecto

Este es un sistema completo de Machine Learning integrado a la aplicaciÃ³n Agua Tres Torres (3T).

**DocumentaciÃ³n principal:** `README.md` (1,183 lÃ­neas - LEER PRIMERO)

---

## ðŸ“š Antes de Cualquier ModificaciÃ³n

1. **LEER** `/opt/cane/3t/ml/README.md` completo
2. **VERIFICAR** estado de la API: `curl http://localhost:8001/health`
3. **HACER BACKUP** si vas a modificar modelos .pkl
4. **PROBAR** cambios en desarrollo antes de producciÃ³n

---

## ðŸš¨ NUNCA Hacer

- âŒ Eliminar archivos `.pkl` sin backup
- âŒ Modificar estructura de `rfm_segments.csv` (API depende de columnas especÃ­ficas)
- âŒ Cambiar puerto 8001 sin actualizar frontend (`NEXT_PUBLIC_ML_API_URL`)
- âŒ Re-entrenar en horario laboral (consume CPU ~15 min)
- âŒ Modificar cÃ³digo de API sin reiniciarla despuÃ©s
- âŒ Hardcodear valores - usar variables de entorno

---

## âœ… SIEMPRE Hacer

- âœ… Backup automÃ¡tico antes de re-entrenar (ya implementado en `retrain_pipeline.py`)
- âœ… Validar `/health` despuÃ©s de cambios en API
- âœ… Documentar cambios significativos en README.md
- âœ… Probar todos endpoints despuÃ©s de modificar API
- âœ… Verificar que frontend sigue funcionando
- âœ… Usar logging apropiado (ya configurado)
- âœ… Seguir estructura de carpetas existente

---

## ðŸ—ï¸ Arquitectura

```
Frontend (Next.js) â†’ API REST (FastAPI) â†’ Modelos ML (.pkl) â†’ Predicciones
```

**Componentes clave:**
- `api/main.py` - API REST (CORE)
- `models/*.pkl` - 6 modelos entrenados
- `src/train_all_models.py` - Entrenamiento
- `src/retrain_pipeline.py` - Re-entrenamiento automÃ¡tico
- `data/processed/` - Datos consolidados

---

## ðŸ“ Estilo de CÃ³digo

### Python (Backend ML)

```python
# âœ… BUENO: Docstrings completos
def train_model(data: pd.DataFrame) -> Model:
    """
    Entrena modelo XGBoost para predicciÃ³n de churn.
    
    Args:
        data: DataFrame con features [recency_days, frequency, monetary]
    
    Returns:
        Modelo entrenado
        
    Raises:
        ValueError: Si faltan columnas requeridas
    """
    pass

# âœ… BUENO: Type hints
def predict_churn(customer_id: str, rfm_data: dict) -> float:
    pass

# âœ… BUENO: Logging apropiado
logging.info("ðŸ”„ Iniciando re-entrenamiento de modelos...")
logging.error(f"âŒ Error al cargar modelo: {str(e)}")

# âŒ MALO: Sin documentaciÃ³n
def train(d):
    pass
```

### TypeScript (Frontend)

```typescript
// âœ… BUENO: Interfaces claras
interface DemandForecastResponse {
  forecast_days: number;
  predictions: Prediction[];
  summary: Summary;
}

// âœ… BUENO: Error handling
try {
  const data = await mlApi.getSegments();
  setSegments(data);
} catch (error) {
  console.error("Error cargando segmentos:", error);
  setError(error.message);
}

// âŒ MALO: Sin tipos
const data = await fetch('/api').then(r => r.json());
```

---

## ðŸ”§ Comandos Ãštiles

```bash
# Iniciar API
cd /opt/cane/3t/ml && ./START_API.sh

# Re-entrenar (con backup)
cd /opt/cane/3t/ml && source venv/bin/activate && python src/retrain_pipeline.py

# Ver logs
tail -f /tmp/ml-api.log

# Verificar modelos
ls -lh /opt/cane/3t/ml/models/*.pkl

# Probar endpoint
curl http://localhost:8001/segments | jq
```

---

## ðŸ“Š Estructura de Respuestas API

Todas las respuestas deben seguir este formato:

```python
# âœ… BUENO: Respuesta estructurada con Pydantic
class PredictionResponse(BaseModel):
    customer_id: str
    prediction: float
    confidence: float
    timestamp: datetime
    
    class Config:
        json_schema_extra = {
            "example": {
                "customer_id": "abc123",
                "prediction": 0.85,
                "confidence": 0.92,
                "timestamp": "2025-11-04T10:00:00"
            }
        }
```

---

## ðŸ› Debugging

### API no responde

```bash
# Ver proceso
ps aux | grep "python api/main.py"

# Ver logs
tail -30 /tmp/ml-api.log

# Reiniciar
pkill -f "python api/main.py"
cd /opt/cane/3t/ml && ./START_API.sh
```

### Modelos no cargan

```bash
# Verificar modelos existen
ls /opt/cane/3t/ml/models/*.pkl

# Ver tamaÃ±os (deben ser >1KB)
ls -lh /opt/cane/3t/ml/models/*.pkl

# Re-entrenar si faltan
python src/train_all_models.py
```

---

## ðŸ“š Referencias RÃ¡pidas

- **README completo:** `/opt/cane/3t/ml/README.md`
- **Resultados:** `/opt/cane/3t/ml/RESULTADOS_MODELOS.md`
- **Dashboard:** `/opt/cane/3t/docs/modules/ML-INSIGHTS.md`
- **Workflows n8n:** `/opt/cane/3t/ml/n8n-workflows/README.md`

---

## ðŸŽ“ Para Nuevos Desarrolladores

1. Leer `README.md` completo (1,183 lÃ­neas)
2. Revisar `RESULTADOS_MODELOS.md` para entender mÃ©tricas
3. Ejecutar `curl http://localhost:8001/health` para verificar estado
4. Acceder a `http://localhost:8001/docs` para ver API interactiva
5. Probar dashboard en `http://localhost:3000/ml-insights`

---

**Ãšltima actualizaciÃ³n:** 2025-11-04  
**VersiÃ³n:** 1.0.0
