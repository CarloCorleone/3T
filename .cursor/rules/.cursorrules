# üß∞ Reglas del Proyecto - Agua Tres Torres (3t)

## üìö Documentaci√≥n
- **SIEMPRE** lee `docs/INDEX.md` para entender la estructura completa
- Documentaci√≥n de m√≥dulos espec√≠ficos en `docs/modules/`
- El sistema tiene 9 m√≥dulos documentados: HOME, DASHBOARD, CLIENTES, PRODUCTOS, PEDIDOS, MAPA, REPORTES, OPTIMIZADOR-RUTAS, PRESUPUESTOS

## üîß Workflow de Desarrollo

### Modos de Operaci√≥n

El proyecto tiene **DOS modos distintos**:

#### üü¢ MODO DESARROLLO (Hot Reload)
```bash
cd /opt/cane/3t
./dev.sh              # Iniciar modo desarrollo
./logs-dev.sh         # Ver logs
```
- **Contenedor**: `3t-app-dev`
- **Puerto interno**: 3001
- **Dominio**: https://dev.3t.loopia.cl
- **Hot reload**: ‚úÖ Cambios en tiempo real (< 1 segundo)
- **Sin rebuild**: ‚úÖ Modificaciones de c√≥digo se reflejan autom√°ticamente
- **Usar cuando**: Est√°s haciendo cambios en el c√≥digo, UI, o cualquier desarrollo activo

#### üî¥ MODO PRODUCCI√ìN (Build Optimizado)
```bash
cd /opt/cane/3t
./prod.sh             # Deploy a producci√≥n
./logs-prod.sh        # Ver logs
```
- **Contenedor**: `3t-app`
- **Puerto interno**: 3002
- **Dominio**: https://3t.loopia.cl
- **Build optimizado**: ‚úÖ Mejor rendimiento
- **Requiere rebuild**: ‚ö†Ô∏è Cualquier cambio necesita `./prod.sh`
- **Usar cuando**: Deploy final para usuarios

### ‚ö†Ô∏è REGLA CR√çTICA: Cambio entre Modos

**SI EL SISTEMA EST√Å EN PRODUCCI√ìN Y NECESITAS HACER CAMBIOS:**

1. **NO modifiques en producci√≥n directamente**
2. **Cambia a modo desarrollo primero:**
   ```bash
   cd /opt/cane/3t
   docker compose down  # Detener producci√≥n
   ./dev.sh            # Iniciar desarrollo
   ```
3. Haz tus cambios (se reflejan autom√°ticamente)
4. Prueba en https://dev.3t.loopia.cl
5. Cuando est√© listo, deploy a producci√≥n:
   ```bash
   ./prod.sh
   ```

### üîÑ Cu√°ndo Necesitas Rebuild

**S√ç necesitas rebuild (modo producci√≥n):**
- ‚úÖ Instalaste nuevas dependencias (`npm install`)
- ‚úÖ Modificaste `package.json` o `package-lock.json`
- ‚úÖ Cambiaste `Dockerfile` o `docker-compose.yml`
- ‚úÖ Modificaste configuraci√≥n (next.config.ts, tailwind.config.ts)

**NO necesitas rebuild (modo desarrollo):**
- ‚ùå Cambios en archivos `.tsx`, `.ts`, `.css`
- ‚ùå Cambios en componentes UI
- ‚ùå Cambios en documentaci√≥n (.md)

## üß© Herramientas MCP (Model Context Protocol)

### SIEMPRE Usa Estas Herramientas

#### üé® Para UI/Componentes: `shadcn-ui` MCP
```typescript
// SIEMPRE usa los comandos MCP de shadcn-ui:
- mcp_shadcn-ui_get_component
- mcp_shadcn-ui_get_component_demo
- mcp_shadcn-ui_list_components

// ‚ùå NO crees componentes manualmente
// ‚úÖ USA los componentes de shadcn/ui v4
```

**Componentes disponibles:**
- Button, Input, Card, Badge, Table, Dialog, Select, Tabs, etc.
- Ver lista completa: `mcp_shadcn-ui_list_components`

#### üóÑÔ∏è Para Base de Datos: `supabase-selfhosted` MCP
```sql
-- SIEMPRE usa los comandos MCP de Supabase:
- mcp_supabase-selfhosted_list_tables
- mcp_supabase-selfhosted_execute_sql
- mcp_supabase-selfhosted_get_database_stats
```

**Configuraci√≥n:**
- **URL**: https://api.loopia.cl
- **Anon Key**: En `/opt/cane/env/3t.env`
- **Prefijo de tablas**: `3t_*`

#### üó∫Ô∏è Para Queries SQL: `postgres-cane` MCP
```sql
-- Para queries read-only:
- mcp_postgres-cane_query
```

## üèóÔ∏è Arquitectura del Proyecto

### Stack Tecnol√≥gico
- **Framework**: Next.js 14 (App Router)
- **Lenguaje**: TypeScript
- **Base de datos**: Supabase (PostgreSQL)
- **UI**: shadcn/ui v4 + Tailwind CSS
- **Mapas**: Google Maps API (Places, Directions, Geocoding)
- **Visualizaci√≥n**: Leaflet.js (m√≥dulo Mapa)
- **Gr√°ficos**: Recharts (m√≥dulo Dashboard)
- **Deployment**: Docker + Nginx Proxy Manager

### Estructura de Archivos
```
/opt/cane/3t/
‚îú‚îÄ‚îÄ app/                    # P√°ginas Next.js (App Router)
‚îÇ   ‚îú‚îÄ‚îÄ page.tsx           # Home
‚îÇ   ‚îú‚îÄ‚îÄ dashboard/         # An√°lisis de ventas
‚îÇ   ‚îú‚îÄ‚îÄ clientes/          # CRUD clientes + Google Maps
‚îÇ   ‚îú‚îÄ‚îÄ productos/         # CRUD productos
‚îÇ   ‚îú‚îÄ‚îÄ pedidos/           # CRUD pedidos
‚îÇ   ‚îú‚îÄ‚îÄ mapa/             # Visualizaci√≥n Leaflet
‚îÇ   ‚îú‚îÄ‚îÄ rutas/            # Optimizador de rutas
‚îÇ   ‚îî‚îÄ‚îÄ presupuestos/     # Generaci√≥n PDF
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ ui/               # shadcn/ui components
‚îÇ   ‚îî‚îÄ‚îÄ app-sidebar.tsx   # Navigation sidebar
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ supabase.ts       # Cliente Supabase + tipos
‚îÇ   ‚îî‚îÄ‚îÄ google-maps.ts    # Integraci√≥n Google Maps
‚îú‚îÄ‚îÄ docs/                 # üìö Documentaci√≥n completa
‚îÇ   ‚îú‚îÄ‚îÄ INDEX.md         # √çndice maestro
‚îÇ   ‚îî‚îÄ‚îÄ modules/         # Docs de cada m√≥dulo
‚îî‚îÄ‚îÄ docker-compose.yml    # Orquestaci√≥n Docker
```

### Variables de Entorno
**Ubicaci√≥n**: `/opt/cane/env/3t.env`
```bash
NODE_ENV=production
PORT=3002  # 3001 para dev, 3002 para prod
NEXT_PUBLIC_SUPABASE_URL=https://api.loopia.cl
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGci...
NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=AIzaSy...
NEXT_TELEMETRY_DISABLED=1
```

## üóÑÔ∏è Base de Datos Supabase

### Tablas Principales (Prefijo `3t_`)
- `3t_customers` - Clientes (Hogar/Empresa)
- `3t_addresses` - Direcciones con GPS (lat/lng de Google Maps)
- `3t_products` - Productos (Botellones, Dispensadores, etc.)
- `3t_orders` - Pedidos diarios
- `3t_dashboard_ventas` - Vista SQL con todas las relaciones

### Convenciones
- **IDs**: UUIDs generados con `crypto.randomUUID()`
- **Tipos de Cliente**: 'Hogar' | 'Empresa' (capitalizado)
- **Estados de Pedido**: 'Pedido' | 'Ruta' | 'Despachado'
- **Estados de Pago**: 'Pendiente' | 'Pagado' | 'Facturado' | 'Interno'
- **Tipos de Pago**: 'Efectivo' | 'Transferencia'

### Consultas con Relaciones
```typescript
const { data } = await supabase
  .from('3t_orders')
  .select(`
    *,
    customer:3t_customers(*),
    address:3t_addresses(*),
    product:3t_products(*)
  `)
```

## üó∫Ô∏è Google Maps API

### APIs Habilitadas
- **Maps JavaScript API** - Mapas interactivos
- **Places API** (versi√≥n ANTIGUA, no "New") - Autocompletado direcciones
- **Directions API** - Rutas optimizadas
- **Distance Matrix API** - C√°lculo de distancias
- **Geocoding API** - Coordenadas GPS

### Restricciones de Seguridad
- **Tipo**: HTTP Referrers (sitios web)
- **Dominios permitidos**:
  - https://3t.loopia.cl/*
  - https://dev.3t.loopia.cl/*
  - http://localhost:3000/*

### Uso en C√≥digo
```typescript
// El script se carga en clientes/page.tsx
<Script
  src={`https://maps.googleapis.com/maps/api/js?key=${process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY}&libraries=places`}
  strategy="afterInteractive"
  onLoad={() => setGoogleMapsLoaded(true)}
/>

// Autocomplete
const autocomplete = new google.maps.places.Autocomplete(inputRef.current, {
  componentRestrictions: { country: 'cl' },
  fields: ['formatted_address', 'geometry', 'address_components'],
  types: ['address']
})
```

## üé® UI/UX con shadcn/ui

### SIEMPRE Usa shadcn/ui MCP
```bash
# Antes de crear cualquier componente UI, verifica si existe:
mcp_shadcn-ui_list_components

# Para ver c√≥mo se usa:
mcp_shadcn-ui_get_component_demo componentName

# Para obtener el c√≥digo fuente:
mcp_shadcn-ui_get_component componentName
```

### Componentes M√°s Usados
- **Button**: Botones con variantes (default, destructive, outline, ghost)
- **Card**: Contenedores con CardHeader, CardTitle, CardDescription, CardContent
- **Dialog**: Modales para formularios
- **Table**: Tablas con TableHeader, TableBody, TableRow, TableCell
- **Select**: Dropdowns
- **Input**: Campos de texto
- **Badge**: Etiquetas de estado
- **Tabs**: Pesta√±as de navegaci√≥n

### Estilos
- **Framework**: Tailwind CSS
- **Colores corporativos**: Ver `docs/BRANDING.md`
- **Dise√±o responsivo**: Mobile-first (md:, lg:, xl: breakpoints)

## üìù Convenciones de C√≥digo

### TypeScript
- ‚úÖ SIEMPRE usa tipos expl√≠citos
- ‚úÖ Importa tipos desde `lib/supabase.ts`
- ‚úÖ Usa `'use client'` cuando necesites hooks o interactividad
- ‚ùå NO uses `any` (usa tipos espec√≠ficos o unknown)

### Componentes
```typescript
// ‚úÖ Correcto
'use client'

import { useState, useEffect } from 'react'
import { supabase, type Customer } from '@/lib/supabase'
import { Button } from '@/components/ui/button'

export default function ClientesPage() {
  const [customers, setCustomers] = useState<Customer[]>([])
  // ...
}

// ‚ùå Incorrecto
import React from 'react'  // No necesario en Next.js App Router
```

### Estados de Carga
- ‚úÖ Siempre incluye `loading` state
- ‚úÖ Muestra feedback al usuario (loading spinners, toasts)
- ‚úÖ Maneja errores con `try/catch` o verificaci√≥n de `error` de Supabase

### Formularios
- ‚úÖ Usa `formData` state para todos los campos
- ‚úÖ Valida datos antes de enviar a Supabase
- ‚úÖ Resetea formularios despu√©s de crear/actualizar
- ‚úÖ Muestra mensajes de √©xito/error con `alert()` o toast

## üîç Troubleshooting Com√∫n

### Problema: Google Maps Autocomplete no funciona
**Soluci√≥n**: 
1. Verifica que `Places API` (antigua) est√° habilitada
2. Verifica z-index en `globals.css`:
   ```css
   .pac-container {
     z-index: 999999 !important;
     position: fixed !important;
     pointer-events: auto !important;
   }
   ```
3. Previene cierre de modal en `DialogContent`:
   ```typescript
   onInteractOutside={(e) => {
     const target = e.target as HTMLElement
     if (target.closest('.pac-container')) {
       e.preventDefault()
     }
   }}
   ```

### Problema: CORS con Supabase
**Soluci√≥n**: Ya est√° configurado en Supabase. Si persiste, ver `docs/troubleshooting/SOLUCION-CORS-SUPABASE.md`

### Problema: Cambios no se reflejan
**Causa**: Est√°s en modo producci√≥n
**Soluci√≥n**: Cambia a modo desarrollo:
```bash
cd /opt/cane/3t
docker compose down
./dev.sh
```

### Problema: Contenedor no arranca
```bash
# Ver logs
docker logs 3t-app  # o 3t-app-dev

# Verificar red
docker network ls | grep cane_net

# Rebuild completo
cd /opt/cane/3t
docker compose down
docker compose build --no-cache
docker compose up -d
```

## üöÄ Comandos Esenciales

### Desarrollo Diario
```bash
cd /opt/cane/3t

# Iniciar desarrollo (hot reload)
./dev.sh

# Ver logs en tiempo real
./logs-dev.sh

# Detener desarrollo
docker compose down
```

### Deploy a Producci√≥n
```bash
cd /opt/cane/3t

# Deploy completo
./prod.sh

# Ver logs
./logs-prod.sh

# Reiniciar (sin rebuild)
docker restart 3t-app
```

### Debugging
```bash
# Ver contenedores corriendo
docker ps | grep 3t

# Ver logs con errores
docker logs 3t-app | grep -i error

# Entrar al contenedor
docker exec -it 3t-app sh

# Ver estad√≠sticas de recursos
docker stats 3t-app
```

## üìö Documentaci√≥n de Referencia

### Para Cualquier Duda
1. **Primero**: Lee `docs/INDEX.md` (√≠ndice maestro)
2. **M√≥dulo espec√≠fico**: Lee `docs/modules/[MODULO].md`
3. **Problema t√©cnico**: Lee `docs/troubleshooting/`
4. **Instalaci√≥n**: Lee `docs/INSTALACION-COMPLETA.md`
5. **Deployment**: Lee `docs/DEPLOYMENT.md`

### M√≥dulos Documentados
- `docs/modules/HOME.md` - P√°gina de inicio
- `docs/modules/DASHBOARD.md` - An√°lisis de ventas
- `docs/modules/CLIENTES.md` - **‚≠ê M√ÅS IMPORTANTE** - Gesti√≥n con Google Maps
- `docs/modules/PRODUCTOS.md` - Cat√°logo
- `docs/modules/PEDIDOS.md` - Gesti√≥n de pedidos
- `docs/modules/MAPA.md` - Visualizaci√≥n Leaflet
- `docs/modules/REPORTES.md` - Planificado
- `docs/modules/OPTIMIZADOR-RUTAS.md` - Optimizaci√≥n con Google Maps
- `docs/modules/PRESUPUESTOS.md` - Generaci√≥n PDF

## üéØ Reglas de Oro

1. **SIEMPRE usa modo desarrollo para cambios activos**
2. **SIEMPRE usa shadcn-ui MCP para componentes UI**
3. **SIEMPRE usa supabase MCP para queries de base de datos**
4. **SIEMPRE lee la documentaci√≥n en `docs/` antes de preguntar**
5. **NUNCA hagas cambios directamente en producci√≥n**
6. **NUNCA uses `any` en TypeScript**
7. **NUNCA expongas API Keys en el c√≥digo**
8. **SIEMPRE valida datos antes de guardar en Supabase**
9. **SIEMPRE incluye manejo de errores**
10. **SIEMPRE documenta cambios importantes en `docs/CHANGELOG.md`**

## üîê Seguridad

- ‚úÖ Variables sensibles en `/opt/cane/env/3t.env` (fuera de Git)
- ‚úÖ API Keys restringidas por dominio
- ‚úÖ HTTPS obligatorio v√≠a Nginx Proxy Manager
- ‚úÖ Validaci√≥n de datos en cliente y servidor
- ‚ùå NO hardcodees credenciales
- ‚ùå NO expongas tokens en logs

## üìä Proyecto Cane (Contexto)

Este proyecto es parte del ecosistema **Cane** que sigue est√°ndares organizacionales:

- Todos los contenedores usan la red `cane_net`
- Variables de entorno en `/opt/cane/env/`
- Vol√∫menes en `/opt/cane/volumes/`
- Cada servicio tiene su propia carpeta en `/opt/cane/`
- Documentaci√≥n clara y estructurada
- Backup autom√°tico con restic

---

**üíß Agua Tres Torres - Sistema de Gesti√≥n**  
**Reglas del Proyecto v3.0**  
**√öltima actualizaci√≥n:** Octubre 11, 2025

**Estas reglas son le√≠das autom√°ticamente por Cursor AI en cada nuevo chat.**

